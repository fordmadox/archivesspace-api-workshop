<!DOCTYPE html>
<html>
<head><link href="css/slides.css" rel="stylesheet" />
   
</head>
<body>
	<nav>
<a rel="nav" href="00-ArchivesSpace-API-Workshop.html" title="Return to start of presentation">Start</a>
<a rel="nav" href="40-ArchivesSpace-API-Workshop.html" title="Previous slide">Prev</a>
<a rel="nav" href="42-ArchivesSpace-API-Workshop.html" title="Next slide">Next</a>
	</nav>
	<section><h1>4. Repositories</h1>

<h2>Let&rsquo;s give this a try in the shell</h2>

<p>We may need a fresh <em>auth_token</em> so let&rsquo;s login first.
After that we can build our request and send it. We&rsquo;ll
wrap up by decoding the JSON response and pretty printing
it.</p>

<pre><code class="language-Python">    auth_token = login(api_url, username, password)
    req = urllib.request.Request(api_url+'/repositories', None, {&quot;X-ArchivesSpace-Session&quot;: auth_token})
    with urllib.request.urlopen(req) as response:
        src = response.read().decode('utf-8')
    result = json.JSONDecoder().decode(src)
    print(json.dumps(result, indent=4, sort_keys=True))
</code></pre>

<h1>4. Repositories</h1>

<h2>Time to put this together in a script</h2>

<pre><code class="language-Python">    #!/usr/bin/env python3
    import urllib.request
    import getpass
    import json
    
    def login (api_url, username, password):
        '''This function takes a username/password and authenticates against the ArchivesSpace REST API'''
        data = urllib.parse.urlencode({'password': password})
        data = data.encode('ascii')
        req = urllib.request.Request(api_url+'/users/'+username+'/login', data)
        with urllib.request.urlopen(req) as response:
            src = response.read().decode('UTF-8')
        result = json.JSONDecoder().decode(src)
        return result['session']

    def create_repo(api_url, auth_token, name, repo_code, org_code = &quot;&quot;, image_url = &quot;&quot;, url = &quot;&quot;):
        '''This function sends a create request to the ArchivesSpace REST API'''
        # Data is getting attached to urlopen() and not req object to trigger a POST
        # ArchivesSpace API likes JSON encoding rather than URL encoding like login
        data = json.JSONEncoder().encode({
                    'jsonmodel_type': 'repository',
                    'name': name,
                    'repo_code': repo_code,
                    'org_code': org_code,
                    'image_url': image_url,
                    'url': url
                }).encode('utf-8')
        # Add our auth_token to your req object
        req = urllib.request.Request(api_url+'/repositories', None, {'X-ArchivesSpace-Session': auth_token})
        response = urllib.request.urlopen(req, data)
        src = response.read().decode('utf-8')
        return json.JSONDecoder().decode(src)

    def list_repos(api_url, auth_token):
        '''List all the repositories, return the listing object'''
        req = urllib.request.Request(api_url+'/repositories', None, {'X-ArchivesSpace-Session': auth_token})
        with urllib.request.urlopen(req) as response:
            src = response.read().decode('utf-8')
        return json.JSONDecoder().decode(src)

                                     
    if __name__ == '__main__':
        api_url = input('ArchivesSpace API URL: ')
        if api_url == '':
            api_url = 'http://localhost:8089'
        username = input('ArchivesSpace username: ')
        password = getpass.getpass('ArchivesSpace password: ')
        auth_token = login(api_url, username, password)
        print('username', username, 'auth_token', auth_token)
        repos = list_repos(api_url, auth_token)
    print(&quot;repositores list&quot;, json.dumps(repos, indent=4))
</code></pre>

<h1>4. Repositories</h1>

<h2>results should look something like</h2>

<pre><code class="language-Python">    username admin auth_token 9321ca79d94517d7018aa1ac4f1b6f2901b522c4b234d3ab9a4602fae9a8d72d
    repositores list [
        {
            &quot;last_modified_by&quot;: &quot;admin&quot;,
            &quot;created_by&quot;: &quot;admin&quot;,
            &quot;create_time&quot;: &quot;2016-07-17T01:55:21Z&quot;,
            &quot;agent_representation&quot;: {
                &quot;ref&quot;: &quot;/agents/corporate_entities/1&quot;
            },
            &quot;repo_code&quot;: &quot;test001&quot;,
            &quot;name&quot;: &quot;test001&quot;,
            &quot;lock_version&quot;: 0,
            &quot;system_mtime&quot;: &quot;2016-07-17T01:55:21Z&quot;,
            &quot;user_mtime&quot;: &quot;2016-07-17T01:55:21Z&quot;,
            &quot;jsonmodel_type&quot;: &quot;repository&quot;,
            &quot;uri&quot;: &quot;/repositories/2&quot;
        },
        {
            &quot;last_modified_by&quot;: &quot;admin&quot;,
            &quot;created_by&quot;: &quot;admin&quot;,
            &quot;create_time&quot;: &quot;2016-07-17T01:55:42Z&quot;,
            &quot;agent_representation&quot;: {
                &quot;ref&quot;: &quot;/agents/corporate_entities/2&quot;
            },
            &quot;repo_code&quot;: &quot;test002&quot;,
            &quot;name&quot;: &quot;test002&quot;,
            &quot;lock_version&quot;: 0,
            &quot;system_mtime&quot;: &quot;2016-07-17T01:55:42Z&quot;,
            &quot;user_mtime&quot;: &quot;2016-07-17T01:55:42Z&quot;,
            &quot;jsonmodel_type&quot;: &quot;repository&quot;,
            &quot;uri&quot;: &quot;/repositories/3&quot;
        }
    ]
    &gt;&gt;&gt; 
</code></pre>

<p>The URL field is what we want to look at. We need the that to request only a single
repositories info.</p>
</section>
</body>
</html>

